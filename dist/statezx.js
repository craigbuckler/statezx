/*
statezx 1.0.1 - Simple client-side state manager with events, synchronization, and indexedDB storage
https://github.com/craigbuckler/statezx#readme
Craig Buckler, 2023-08-25
*/
var w=class{#e=null;#r=null;#s=null;constructor(t,e,r){return this.#r=t||"db",this.#s=e||1,this.#i(r)}connect(){return this.#i().then(()=>!0).catch(()=>!1)}close(){this.#e.close(),this.#e=null}#i(t){return new Promise((e,r)=>{if(!("indexedDB"in window)){r(new Error("No indexedDB support"));return}let n=indexedDB.open(this.#r,this.#s);n.onsuccess=()=>{this.#e=n.result,e(this)},n.onerror=s=>{r(new Error(`IndexedDB error ${s.target.errorCode}: ${s.target.message}`,{cause:s}))},t&&(n.onupgradeneeded=s=>{t(n.result,s.oldVersion,s.newVersion)})})}get isConnected(){return!!this.#e}get name(){return this.#r}get version(){return this.#s}#l(t,e,r){return new Promise((n,s)=>{let{transaction:o,store:i}=this.#o(t,null,!0);o.oncomplete=()=>n(),o.onerror=l=>{s(new Error(l.target.error.message,{cause:l}))},e=Array.isArray(e)?e:[e],e.forEach(l=>{r?i.put(l):i.add(l)}),o.commit()})}add({store:t,item:e=[]}={}){return this.#l(t,e,!1)}put({store:t,item:e=[]}={}){return this.#l(t,e,!0)}#t(t,e,r,n){return new Promise((s,o)=>{n=Array.isArray(n)?n:[n];let i=r==="delete"||r==="clear",l=this.#o(t,e,i).store[r](...n);l.onsuccess=()=>s(l.result),l.onerror=()=>o(l.error??!1)})}count({store:t,index:e,lowerBound:r,upperBound:n}={}){return this.#t(t,e,"count",this.#n(r,n))}get({store:t,index:e,key:r}={}){return this.#t(t,e,"get",r)}getAll({store:t,index:e,lowerBound:r,upperBound:n,count:s}={}){return this.#t(t,e,"getAll",[this.#n(r,n),s])}getAllKeys({store:t,index:e,lowerBound:r,upperBound:n,count:s}={}){return this.#t(t,e,"getAllKeys",[this.#n(r,n),s])}delete({store:t,key:e}={}){return this.#t(t,null,"delete",[e])}deleteAll({store:t,index:e,lowerBound:r,upperBound:n}={}){return this.#t(t,e,"delete",[this.#n(r,n)])}clear({store:t}={}){return this.#t(t,null,"clear")}getCursor({store:t,index:e,lowerBound:r,upperBound:n,direction:s="next",callback:o}={}){return new Promise((i,l)=>{let c=this.#o(t,e).store.openCursor(this.#n(r,n),s);c.onsuccess=()=>{let p=c.result;p?p.advance(o&&o(p)||1):i(!0)},c.onerror=()=>l(c.error)})}drop(){return new Promise((t,e)=>{this.close();let r=indexedDB.deleteDatabase(this.#r);r.onsuccess=()=>{this.#r=null,this.#s=null,t(!0)},r.onerror=()=>e(!1)})}#o(t,e,r){let n=this.#e.transaction(t,r?"readwrite":"readonly",{durability:r?"strict":"default"}),s=n.objectStore(t);return{transaction:n,store:e&&!r?s.index(e):s}}#n(t,e){let r;return t&&e?r=IDBKeyRange.bound(t,e):t?r=IDBKeyRange.lowerBound(t):e&&(r=IDBKeyRange.upperBound(e)),r}};var d=new Map,h=new Map,a="statezx",x="stateIdx",m=new BroadcastChannel(a),f,u,y=3,v=window.requestIdleCallback||(t=>setTimeout(t,20)),g=class extends EventTarget{#e=null;constructor(e){super(),this.#e=e}get stateId(){return this.#e}set(e,r){return typeof r>"u"?Reflect.deleteProperty(this,e):Reflect.set(this,e,r)}addEventListener(){super.addEventListener.apply(this,arguments)}removeEventListener(){super.removeEventListener.apply(this,arguments)}dispatchEvent(e){let r={detail:e,bubbles:!1,cancelable:!1};super.dispatchEvent(new CustomEvent(e.property,r)),super.dispatchEvent(new CustomEvent("*",r))}},E={set:(t,e,r)=>B(t,e,r),deleteProperty:(t,e)=>B(t,e),get:(t,e)=>{let r=t[e];return typeof r=="function"?function(...n){return r.apply(t,n)}:Reflect.get(t,e)}};async function R(t,e){t=t||a,d.has(t)||d.set(t,new Proxy(new g(t),E));let r=d.get(t);return await b(),await D(r,{...e}),r}async function b(){u||!y||(y--,u=await new w(`${a}DB`,1,(t,e)=>{switch(e){case 0:t.createObjectStore(a,{keyPath:"id"}).createIndex(x,"state",{unique:!1})}}))}async function D(t,e){if(!u)return;(await u.getAll({store:a,index:x,lowerBound:t.stateId,upperBound:t.stateId})).forEach(n=>{let s=n.property;t.set(s,n.value),delete e[s]});for(let n in e)t[n]=e[n]}function B(t,e,r){let n=Reflect.get(t,e),s=!0;if(n===r)return s;if(typeof r>"u"?s=Reflect.deleteProperty(t,e):s=Reflect.set(t,e,r),s){let o=t.stateId+"."+e,i=h.get(o)||{state:t,property:e,valueOld:n};i.value=r,h.set(o,i),f=f||v(P)}return s}async function P(){let t=h.values(),e;do{if(e=t.next().value,!e||e.value===e.valueOld)continue;let{state:r,property:n,value:s}=e;if(r.dispatchEvent(e),!u)continue;let o=r.stateId,i=o+"."+n;typeof s>"u"?await u.delete({store:a,key:i}):await u.put({store:a,item:{id:i,state:o,property:n,value:s}}),m.postMessage({state:o,property:n,value:s})}while(e);h.clear(),f=null}m.onmessage=t=>{let{state:e,property:r,value:n}=t.data,s=d.get(e);if(s){let o={state:s,property:r,value:n,valueOld:s[r]};s.set(r,n),s.dispatchEvent(o)}};export{w as PixDB,R as stateZx};
